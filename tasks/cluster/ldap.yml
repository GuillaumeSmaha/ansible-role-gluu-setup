
- name: "Gluu Cluster - OpenLDAP - listen for external IP"
  lineinfile:
    path: /opt/gluu-server-{{ gluu_version }}/opt/symas/etc/openldap/symas-openldap.conf
    regexp: '^HOST_LIST=".*'
    line: 'HOST_LIST="ldaps://127.0.0.1:1636/ ldaps://{{ gluu_ip }}:1636/"'

# - name: "Gluu Cluster - OpenLDAP - Update ExtraArgs"
#   lineinfile:
#     path: /opt/gluu-server-{{ gluu_version }}/opt/symas/etc/openldap/symas-openldap.conf
#     regexp: '^EXTRA_SLAPD_ARGS="'
#     line: 'EXTRA_SLAPD_ARGS="-F /opt/symas/etc/openldap/slapd.d"'
#   when: gluu_cluster_ldap_replication

- name: Check if LDAP replication is already setup
  stat:
    path: /opt/gluu-server-{{ gluu_version }}/opt/gluu/data/accesslog_db
  register: ldap_replication_is_setup
  when: gluu_cluster_ldap_replication

- name: "Gluu Cluster - OpenLDAP - Replication"
  block:
    - name: "Gluu Cluster - OpenLDAP - Create accesslog_db directory"
      file:
        path: '/opt/gluu-server-{{ gluu_version }}/opt/gluu/data/accesslog_db'
        state: directory
        
    - name: "Gluu Cluster - OpenLDAP - Update permission directory"
      command: '{{ gluu_container_command }} "chown -R ldap /opt/gluu/data/"'
        
    - name: "Gluu Cluster - OpenLDAP - Stop LDAP server"
      command: '{{ gluu_container_command }} "service solserver stop'

    - set_fact:
        first_ldap_host: ""

    - set_fact:
        first_ldap_host: "{{ item }}"
      when: "'ldap' in hostvars[item].gluu_modules and first_ldap_host == ''"
      with_items:
        "{{ groups['gluu-servers'] }}"
        
    - name: "Gluu Cluster - OpenLDAP - Erase LDAP database file"
      command: '{{ gluu_container_command }} "rm /opt/gluu/data/main_db/*.mdb"'
      when: "inventory_hostname == first_ldap_host"

  lineinfile:
    path: /opt/gluu-server-{{ gluu_version }}/opt/symas/etc/openldap/symas-openldap.conf
    regexp: '^EXTRA_SLAPD_ARGS="'
    line: 'EXTRA_SLAPD_ARGS="-F /opt/symas/etc/openldap/slapd.d"'
  when: gluu_cluster_ldap_replication and gluu_cluster_ldap_replication.stat.exists == False
